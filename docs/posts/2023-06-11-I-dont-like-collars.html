<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hervé Bredin">
<meta name="dcterms.date" content="2023-06-11">
<meta name="description" content="Why you should not use forgiveness collars when evaluating diarization systems">

<title>Hervé Bredin - I don’t like collars!</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-2N1PYH6CZP"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-2N1PYH6CZP', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Hervé Bredin</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../consulting.html" rel="" target="">
 <span class="menu-text">Consulting</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About me</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../collab.html" rel="" target="">
 <span class="menu-text">Collaborators</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/hbredin" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/hbredin" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">I don’t like collars!</h1>
                  <div>
        <div class="description">
          Why you should <strong>not</strong> use forgiveness collars when evaluating diarization systems
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Hervé Bredin </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 11, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>In the last ten years or so, I spent a decent amount of my time designing, evaluating and debugging speaker diarization systems:</p>
<ul>
<li>I am the creator of the popular <a href="https://github.com/pyannote/pyannote-audio"><code>pyannote.audio</code></a> open source speaker diarization library</li>
<li>I participated to a bunch of speaker diarization benchmarks</li>
<li>I also created the <a href="https://pyannote.github.io/pyannote-metrics"><code>pyannote.metrics</code></a> open source library that provides a large collection of metrics for evaluating speaker diarization systems.</li>
</ul>
<p>In this blog post, I will try (and hopefully succeed) to convince you that evaluating and comparing speaker diarization systems using the infamous 250ms “forgiveness collar” is a bad idea.</p>
<p>Let’s consider this 10s-long conversation between two speakers: <code>SPEAKER_1</code> and <code>SPEAKER_2</code>.</p>
<div class="cell" data-execution_count="3">
<div class="cell-output cell-output-display" data-execution_count="3">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-3-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Now, let’s assume that an (automatic) speaker diarization system produces this hypothesis for the same conversation:</p>
<div class="cell" data-execution_count="4">
<div class="cell-output cell-output-display" data-execution_count="4">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The system made three types of errors:</p>
<ul>
<li><em>missed detection</em>, it missed the beginning of <code>SPEAKER_1</code> turn around time t=1s;</li>
<li><em>false alarm</em>: it marked <code>SPEAKER_1</code> has active when it is not, around time t=4s</li>
<li><em>confusion</em>: it confused <code>SPEAKER_2</code> for <code>SPEAKER_1</code> around time t=5s</li>
</ul>
<div class="cell" data-execution_count="7">
<div class="cell-output cell-output-display" data-execution_count="7">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The most common metric used for evaluating speaker diarization systems is the <em>diarization error rate</em> which is defined as the ratio between the total duration of this three types of errors divided by the total duration of speech according to the manual annotation:</p>
<p><span class="math display">\[\mbox{diarization error rate} = \frac{\mbox{missed detection} + \mbox{false alarm} + \mbox{confusion}}{\mbox{total duration of speech}}\]</span></p>
<p>which you can compute with <a href="https://pyannote.github.io/pyannote-metrics/"><code>pyannote.metrics</code></a> as follows:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>metric <span class="op">=</span> DiarizationErrorRate()</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>der <span class="op">=</span> metric(reference, hypothesis)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"DER = </span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span>der<span class="sc">:.1f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">DER = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10.0</span>%
</pre>
</div>
</div>
<p>A detailed duration breakdown of this value can be obtained using the <code>detailed=True</code> option:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metric(reference, hypothesis, detailed<span class="op">=</span><span class="va">True</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'false alarm'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.20000000000000018</span>,
    <span style="color: #008000; text-decoration-color: #008000">'correct'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5.6</span>,
    <span style="color: #008000; text-decoration-color: #008000">'missed detection'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.19999999999999996</span>,
    <span style="color: #008000; text-decoration-color: #008000">'confusion'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.20000000000000018</span>,
    <span style="color: #008000; text-decoration-color: #008000">'total'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.0</span>,
    <span style="color: #008000; text-decoration-color: #008000">'diarization error rate'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.10000000000000005</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<p>The above equation becomes:</p>
<p><span class="math display">\[\mbox{diarization error rate} = \frac{\mbox{200ms} + \mbox{200ms} + \mbox{200ms}}{\mbox{6s}} = 10\%\]</span></p>
<section id="forgiveness-collars" class="level2">
<h2 class="anchored" data-anchor-id="forgiveness-collars"><em>“Forgiveness”</em> collars</h2>
<p>It is very difficult for (human) annotators to precisely define the start and end time of speaker turns… and even more so in presence of adverse acoustic conditions or overlapping speech. Therefore, the speaker diarization community came up with the notion of <em>“forgiveness collars”</em>: small regions (typically a few hundred milliseconds) centered on the start and end time of every single speaker turns during which systems are <em>forgiven</em> for their mistakes.</p>
<p>In the above conversation, <em>“250ms forgiveness collars”</em> would look like this:</p>
<div class="cell" data-execution_count="10">
<div class="cell-output cell-output-display" data-execution_count="10">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Noticed how every single error made by the automatic system falls within the forgiveness collars?</p>
<div class="cell" data-execution_count="11">
<div class="cell-output cell-output-display" data-execution_count="11">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Consequently, evaluating the very same system with forgiveness collars results in a perfect diarization error rate!</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>der <span class="op">=</span> metric_with_collars(reference, hypothesis)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"DER (with collars) = </span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span>der<span class="sc">:.1f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">DER <span style="font-weight: bold">(</span>with collars<span style="font-weight: bold">)</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0</span>%
</pre>
</div>
</div>
<p>No false alarm, no missed detection, no confusion, nothing!</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metric_with_collars(reference, hypothesis, detailed<span class="op">=</span><span class="va">True</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'false alarm'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0</span>,
    <span style="color: #008000; text-decoration-color: #008000">'correct'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5.0</span>,
    <span style="color: #008000; text-decoration-color: #008000">'missed detection'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0</span>,
    <span style="color: #008000; text-decoration-color: #008000">'confusion'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0</span>,
    <span style="color: #008000; text-decoration-color: #008000">'total'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5.0</span>,
    <span style="color: #008000; text-decoration-color: #008000">'diarization error rate'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<p>That is the whole point of collars: forgiving systems for making mistakes in regions were even humans cannot be 100% correct.</p>
<p>Seems reasonable, right? Right? RIGHT?</p>
</section>
<section id="i-dont-like-collars-250ms-collars-are-not-what-you-think-they-are" class="level2">
<h2 class="anchored" data-anchor-id="i-dont-like-collars-250ms-collars-are-not-what-you-think-they-are">I don’t like collars! “250ms” collars are not what you think they are!</h2>
<p>Did you notice that those <em>“250ms”</em> collars actually are 500ms long? There! You have it! <strong>The first reason I don’t like collars!</strong></p>
<p>For some reason, the speaker diarization community decided a long time ago that “250ms” collars actually are 500ms-long regions centered on speaker boundaries: 250ms on the left, 250ms on the right. This has been implemented like this since the good old <code>md-eval.pl</code> Perl (😱) script and <a href="https://github.com/nryant/dscore"><code>nryant/dscore</code></a> did a good job ensuring that their Python (🤩) version is <a href="https://github.com/nryant/dscore/blob/824f126ae9e78cf889e582eec07941ffe3a7d134/scorelib/metrics.py#L406-L409">consistent</a> with it.</p>
<div class="cell" data-execution_count="15">
<div class="cell-output cell-output-display" data-execution_count="15">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>When designing <a href="http://pyannote.github.io/pyannote-metrics/"><code>pyannote.metrics</code></a>, I decided to make it clear from the beginning what the overall duration of the collar will be so <a href="https://github.com/pyannote/pyannote-metrics/issues/63">you should use <code>collar=0.5</code></a> to actually be consistent with <code>md-eval.pl</code> <em>“250ms”</em> collar. This is how the above <code>metric_with_collars</code> has been instantiated:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>metric_with_collars <span class="op">=</span> DiarizationErrorRate(collar<span class="op">=</span><span class="fl">0.500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="i-dont-like-collars-they-depend-on-annotation-guidelines" class="level2">
<h2 class="anchored" data-anchor-id="i-dont-like-collars-they-depend-on-annotation-guidelines">I don’t like collars! They depend on annotation guidelines!</h2>
<p>A second reason I don’t like collars is that the speaker diarization community somehow <em>hardcoded</em> this 250ms collar duration despite the fact that every benchmarking initiative gives different instructions to their pool of human annotators regarding how to annotate intra-speaker gaps:</p>
<ul>
<li><a href="https://dihardchallenge.github.io/dihard3/docs/third_dihard_eval_plan_v1.2.pdf">DIHARD evaluation plan</a> says that <em>“small pauses [shorter than] 200 ms by a speaker are not considered to be segmentation breaks and should be bridged into a single continuous segment”</em>;</li>
<li><a href="https://arxiv.org/abs/2007.01216">VoxConverse guidelines</a> say that <em>“speech segments are split when pauses are greater than [250 ms]”</em>;</li>
<li><a href="http://catedrartve.unizar.es/reto2022/SDIAC2022_Evalplan.pdf">Albayzin 2022 evaluation plan</a> goes even further by requesting that <em>“consecutive segments of the same speaker with a silence of less that 2 seconds […] are considered as a single segment”</em>.</li>
</ul>
<div class="cell" data-execution_count="17">
<div class="cell-output cell-output-display" data-execution_count="17">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>For the above conversation, <em>DIHARD</em> guidelines would lead to the following “reference” annotation:</p>
<div class="cell" data-execution_count="18">
<div class="cell-output cell-output-display" data-execution_count="18">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>With <em>VoxConverse</em> guidelines, it would look like this:</p>
<div class="cell" data-execution_count="19">
<div class="cell-output cell-output-display" data-execution_count="19">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Now, let’s compare those two “reference” annotations, using DIHARD as reference and VoxConverse as hypothesis, and vice-versa…</p>
<p>First with collars:</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>(metric_with_collars(dihard, voxconverse), metric_with_collars(voxconverse, dihard))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>(0.0, 0.056818181818181816)</code></pre>
</div>
</div>
<p>Then without collars:</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>(metric(dihard, voxconverse), metric(voxconverse, dihard))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>(0.04424778761061947, 0.0423728813559322)</code></pre>
</div>
</div>
<p>Diarization error rates are much more stable without collars!</p>
<p><strong>Full disclosure</strong>: I agree that this example is 100% made up and a more in-depth analysis should be performed at a larger scale but still… I don’t like collars!</p>
<p>You might argue that those first two reasons why I don’t like collars might be anecdotal (and you might actually be right).</p>
<p>But, brace yourself, I kept the best for the end!</p>
</section>
<section id="i-dont-like-collars-they-dont-play-well-with-overlapping-speech" class="level2">
<h2 class="anchored" data-anchor-id="i-dont-like-collars-they-dont-play-well-with-overlapping-speech">I don’t like collars! They don’t play well with overlapping speech</h2>
<p>As automatic speaker diarization systems are getting better and better, diarization error rates on standard benchmarks are getting dangerously close to zero: the winning team of the last VoxSRC 2022 challenge reached a DER (with “250ms” collars) of 4.7% while <a href="https://huggingface.co/pyannote/speaker-diarization/blob/VoxSRC2022/README.md">pyannote.audio pipeline</a> reaches 5.7% (or 10.4% without collar).</p>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyannote.database.util <span class="im">import</span> load_rttm</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># manual annotations</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>references <span class="op">=</span> load_rttm(<span class="st">"voxconverse.test.manual.rttm"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># output of pyannote pipeline</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>hypotheses <span class="op">=</span> load_rttm(<span class="st">"voxconverse.test.auto.rttm"</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>metric <span class="op">=</span> DiarizationErrorRate()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>metric_with_collars <span class="op">=</span> DiarizationErrorRate(collar<span class="op">=</span><span class="fl">0.500</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> uri <span class="kw">in</span> references:</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    metric(references[uri], hypotheses[uri])</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    metric_with_collars(references[uri], hypotheses[uri])</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>report <span class="op">=</span> metric.report(display<span class="op">=</span><span class="va">False</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>without_collars <span class="op">=</span> {</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'false alarm'</span>: report[<span class="st">'false alarm'</span>][<span class="st">'%'</span>],</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'missed detection'</span>: report[<span class="st">'missed detection'</span>][<span class="st">'%'</span>],</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'speaker confusion'</span>: report[<span class="st">'confusion'</span>][<span class="st">'%'</span>]</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>report <span class="op">=</span> metric_with_collars.report(display<span class="op">=</span><span class="va">False</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>with_collars <span class="op">=</span> {</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'false alarm'</span>: report[<span class="st">'false alarm'</span>][<span class="st">'%'</span>],</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'missed detection'</span>: report[<span class="st">'missed detection'</span>][<span class="st">'%'</span>],</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'speaker confusion'</span>: report[<span class="st">'confusion'</span>][<span class="st">'%'</span>]</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">With 250ms collars: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5.7</span>%
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Without collars:    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10.4</span>%
</pre>
</div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>report <span class="op">=</span> metric.report(display<span class="op">=</span><span class="va">False</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>without_collars <span class="op">=</span> {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'false alarm'</span>: report[<span class="st">'false alarm'</span>][<span class="st">'%'</span>],</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'missed detection'</span>: report[<span class="st">'missed detection'</span>][<span class="st">'%'</span>],</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'speaker confusion'</span>: report[<span class="st">'confusion'</span>][<span class="st">'%'</span>]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>report <span class="op">=</span> metric_with_collars.report(display<span class="op">=</span><span class="va">False</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>with_collars <span class="op">=</span> {</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'false alarm'</span>: report[<span class="st">'false alarm'</span>][<span class="st">'%'</span>],</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'missed detection'</span>: report[<span class="st">'missed detection'</span>][<span class="st">'%'</span>],</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'speaker confusion'</span>: report[<span class="st">'confusion'</span>][<span class="st">'%'</span>]</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>without_collars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>{'false alarm': 3.674856111709354,
 'missed detection': 3.1353199135206022,
 'speaker confusion': 3.5831824051016747}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>with_collars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>{'false alarm': 1.4815401669927144,
 'missed detection': 1.5836474415222679,
 'speaker confusion': 2.6818838564974077}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>metric_with_collars.report(display<span class="op">=</span><span class="va">False</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>diarization error rate  %         5.747071
total                        130955.410000
correct                      125369.466000
                        %        95.734469
false alarm                    1940.157000
                        %         1.481540
missed detection               2073.872000
                        %         1.583647
confusion                      3512.072000
                        %         2.681884
Name: TOTAL, dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>references.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>dict_keys(['aepyx', 'aggyz', 'aiqwk', 'aorju', 'auzru', 'bgvvt', 'bidnq', 'bjruf', 'bmsyn', 'bpzsc', 'bvqnu', 'bvyvm', 'bxcfq', 'byapz', 'cadba', 'cawnd', 'clfcg', 'cpebh', 'cqfmj', 'crorm', 'crylr', 'cvofp', 'cwbvu', 'dgvwu', 'diysk', 'dkabn', 'dlast', 'dohag', 'duvox', 'dxbbt', 'dxokr', 'dzsef', 'dzxut', 'eauve', 'eazeq', 'eddje', 'eguui', 'eoyaz', 'epygx', 'eqsta', 'erslt', 'eucfa', 'euqef', 'ezxso', 'fijfi', 'fowhl', 'fpfvy', 'fqrnu', 'fuzfh', 'fvhrk', 'fxnwf', 'fyqoe', 'fzwtp', 'gcfwp', 'gcvrb', 'gfneh', 'gkiki', 'gmmwm', 'gtjow', 'gtnjb', 'gukoa', 'guvqf', 'gwloo', 'gylzn', 'gyomp', 'gzhwb', 'hcyak', 'heolf', 'hhepf', 'hqhrb', 'iabca', 'iacod', 'ibrnm', 'ifwki', 'iiprr', 'ikhje', 'iowob', 'isrps', 'isxwc', 'jbowg', 'jdrwl', 'jeymh', 'jgiyq', 'jjkrt', 'jjvkx', 'jrfaz', 'jsbdo', 'jsymf', 'jttar', 'jwggf', 'jxpom', 'jxydp', 'jzkzt', 'kajfh', 'kgjaa', 'kmjvh', 'kmunk', 'kpjud', 'ktvto', 'kvkje', 'kzmyi', 'laoyl', 'lbfnx', 'ledhe', 'leneg', 'lhuly', 'lilfy', 'ljpes', 'lkikz', 'lpola', 'lscfc', 'ltgmz', 'lubpm', 'luobn', 'mbzht', 'mclsr', 'mhwyr', 'mjmgr', 'mkhie', 'mqtep', 'msbyq', 'mupzb', 'mxdpo', 'mxduo', 'myjoe', 'neiye', 'nitgx', 'nkqzr', 'nlvdr', 'nprxc', 'nqcpi', 'nqyqm', 'ocfop', 'ofbxh', 'olzkb', 'ooxlj', 'optsn', 'oqwpd', 'otmpf', 'oubab', 'ouvtt', 'pccww', 'pgtkk', 'pkwrt', 'poucc', 'ppexo', 'ptses', 'pwnsw', 'pxqme', 'pzxit', 'qadia', 'qajyo', 'qeejz', 'qlrry', 'qoarn', 'qwepo', 'qxana', 'ralnu', 'rarij', 'rmvsh', 'rpkso', 'rsypp', 'rxulz', 'ryken', 'sbrmv', 'sebyw', 'sexgc', 'sfdvy', 'svxzm', 'swbnm', 'sxqvt', 'tbjqx', 'thnuq', 'tiido', 'tkhgs', 'tkybe', 'tnjoh', 'tpnyf', 'tpslg', 'tvtoe', 'uedkc', 'uevxo', 'uhfrw', 'uicid', 'upshw', 'uqxlg', 'usqam', 'utial', 'vdlvr', 'vgaez', 'vgevv', 'vncid', 'vtzqw', 'vuewy', 'vylyk', 'vzuru', 'wcxfk', 'wdvva', 'wemos', 'wibky', 'wlfsf', 'wprog', 'wwvcs', 'wwzsk', 'xffsa', 'xggbk', 'xkgos', 'xkmqx', 'xlsme', 'xlyov', 'xmyyy', 'xqxkt', 'xtdcl', 'xtzoq', 'xvxwv', 'ybhwz', 'ygrip', 'ylgug', 'ylzez', 'ytmef', 'ytula', 'yukhy', 'yzvon', 'zedtj', 'zehzu', 'zfzlc', 'zowse', 'zqidv', 'zsgto', 'zzsba', 'zztbo', 'zzyyo'])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>r, h <span class="op">=</span> metric.uemify(references[<span class="st">'aepyx'</span>], hypotheses[<span class="st">'aepyx'</span>], collar<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/hbredin/miniconda3/envs/pyannote-mps/lib/python3.9/site-packages/pyannote/metrics/utils.py:200: UserWarning: 'uem' was approximated by the union of 'reference' and 'hypothesis' extents.
  warnings.warn(</code></pre>
</div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyannote.core <span class="im">import</span> notebook, Segment</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>notebook.reset()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>references[<span class="st">'aepyx'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-29-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>to_overlap(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>to_overlap(r).get_timeline().duration()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>2.329999999999984</code></pre>
</div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>to_overlap(references[<span class="st">'aepyx'</span>]).get_timeline().duration()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>3.3899999999999864</code></pre>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>metric <span class="op">=</span> DiarizationErrorRate()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>metric_with_collars <span class="op">=</span> DiarizationErrorRate(collar<span class="op">=</span><span class="fl">0.500</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> uri <span class="kw">in</span> references:</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    metric(references[uri], hypotheses[uri])</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    metric_with_collars(references[uri], hypotheses[uri])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/hbredin/miniconda3/envs/pyannote-mps/lib/python3.9/site-packages/pyannote/metrics/utils.py:200: UserWarning: 'uem' was approximated by the union of 'reference' and 'hypothesis' extents.
  warnings.warn(</code></pre>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>(metric[<span class="st">'total'</span>] <span class="op">-</span> metric_with_collars[<span class="st">'total'</span>]) <span class="op">/</span> metric[<span class="st">'total'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>0.09556733728896123</code></pre>
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="bu">abs</span>(metric)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>0.1039335843033163</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="bu">abs</span>(metric_with_collars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>0.0574707146501239</code></pre>
</div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyannote.core <span class="im">import</span> Annotation, Timeline</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_overlap(annotation: Annotation) <span class="op">-&gt;</span> Annotation:</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Get overlapped speech regions</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co">    annotation : Annotation</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Speaker annotation.</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co">    overlap : Annotation</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Overlapped speech annotation.</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    overlap <span class="op">=</span> Timeline(uri<span class="op">=</span>annotation.uri)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (s1, t1), (s2, t2) <span class="kw">in</span> annotation.co_iter(annotation):</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>        l1 <span class="op">=</span> annotation[s1, t1]</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        l2 <span class="op">=</span> annotation[s2, t2]</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> l1 <span class="op">==</span> l2:</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>        overlap.add(s1 <span class="op">&amp;</span> s2)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> overlap.support().to_annotation(generator<span class="op">=</span><span class="st">"string"</span>, modality<span class="op">=</span><span class="st">"overlap"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_overlap(annotation: Annotation) <span class="op">-&gt;</span> Annotation:</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    overlap <span class="op">=</span> Timeline(uri<span class="op">=</span>annotation.uri)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (s1, t1), (s2, t2) <span class="kw">in</span> annotation.co_iter(annotation):</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        l1 <span class="op">=</span> annotation[s1, t1]</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>        l2 <span class="op">=</span> annotation[s2, t2]</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> l1 <span class="op">==</span> l2:</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>        overlap.add(s1 <span class="op">&amp;</span> s2)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    no_overlap <span class="op">=</span> overlap.gaps(support<span class="op">=</span>annotation.get_timeline().extent())</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    modified_annotation <span class="op">=</span> annotation.crop(no_overlap)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> segment <span class="kw">in</span> overlap:</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> random.choice(annotation.crop(segment).labels())</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>        modified_annotation[segment] <span class="op">=</span> label</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modified_annotation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>modified_hypotheses <span class="op">=</span> {uri: remove_overlap(hypotheses[uri]) <span class="cf">for</span> uri <span class="kw">in</span> hypotheses}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>metric <span class="op">=</span> DiarizationErrorRate()</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>metric_with_collars <span class="op">=</span> DiarizationErrorRate(collar<span class="op">=</span><span class="fl">0.500</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> uri <span class="kw">in</span> references:</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    metric(references[uri], modified_hypotheses[uri])</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    metric_with_collars(references[uri], modified_hypotheses[uri])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/hbredin/miniconda3/envs/pyannote-mps/lib/python3.9/site-packages/pyannote/metrics/utils.py:200: UserWarning: 'uem' was approximated by the union of 'reference' and 'hypothesis' extents.
  warnings.warn(</code></pre>
</div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="bu">abs</span>(metric)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>0.11150866672449616</code></pre>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="bu">abs</span>(metric_with_collars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>0.06293896525542539</code></pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fl">0.06304432936371232</span> <span class="op">-</span> <span class="fl">0.0574707146501239</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>0.005573614713588422</code></pre>
</div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fl">0.1115695191642017</span> <span class="op">-</span> <span class="fl">0.1039335843033163</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>0.007635934860885402</code></pre>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>(<span class="fl">0.1115695191642017</span> <span class="op">-</span> <span class="fl">0.1039335843033163</span>)<span class="op">/</span><span class="fl">0.1115695191642017</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>0.06844104839823917</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>Not dealing overlap <span class="kw">is</span> only penalize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>(<span class="fl">0.06304432936371232</span> <span class="op">-</span> <span class="fl">0.0574707146501239</span>) <span class="op">*</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.5573614713588422</code></pre>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>aepyx <span class="op">=</span> voxconverse[<span class="st">'aepyx'</span>]</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>aepyx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>KeyError: 'a'</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>to_overlap(aepyx).get_timeline()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-49-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> amount_of_overlap(annotation: Annotation) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    overlap <span class="op">=</span> to_overlap(annotation)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(segment.duration <span class="cf">for</span> segment, _ <span class="kw">in</span> overlap.itertracks()) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>amount_of_overlap(aepyx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>3.3899999999999864</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> with_collar(annotation: Annotation) <span class="op">-&gt;</span> Annotation:</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> pyannote.metrics.diarization <span class="im">import</span> DiarizationErrorRate</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    metric <span class="op">=</span> DiarizationErrorRate()</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> metric.uemify(annotation, annotation, collar<span class="op">=</span><span class="fl">0.5</span>)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>with_collar(aepyx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-53-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>amount_of_overlap(with_collar(aepyx))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>2.329999999999984</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>raw_overlap <span class="op">=</span> <span class="bu">sum</span>(amount_of_overlap(reference) <span class="cf">for</span> _, reference <span class="kw">in</span> voxconverse.items())</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>raw_overlap</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>4283.1200000000035</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>overlap_with_collar <span class="op">=</span> <span class="bu">sum</span>(amount_of_overlap(with_collar(reference)) <span class="cf">for</span> _, reference <span class="kw">in</span> voxconverse.items())</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>overlap_with_collar</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>2031.489999999998</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> amount_of_speech(annotation: Annotation) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(segment.duration <span class="cf">for</span> segment, _ <span class="kw">in</span> annotation.itertracks())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>raw_speech <span class="op">=</span> <span class="bu">sum</span>(amount_of_speech(reference) <span class="cf">for</span> _, reference <span class="kw">in</span> voxconverse.items())</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>raw_speech</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>144792.88</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>speech_with_collar <span class="op">=</span> <span class="bu">sum</span>(amount_of_speech(with_collar(reference)) <span class="cf">for</span> _, reference <span class="kw">in</span> voxconverse.items())</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>speech_with_collar</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/hbredin/miniconda3/envs/pyannote/lib/python3.9/site-packages/pyannote/metrics/utils.py:200: UserWarning: 'uem' was approximated by the union of 'reference' and 'hypothesis' extents.
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>130955.40999999993</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>raw_ratio <span class="op">=</span> raw_overlap <span class="op">/</span> raw_speech</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span>raw_ratio<span class="sc">:.2f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.96</span>%
</pre>
</div>
</div>
<p>{{raw_ratio}}</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>ratio_with_collar <span class="op">=</span> overlap_with_collar <span class="op">/</span> speech_with_collar</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span>ratio_with_collar<span class="sc">:.2f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.55</span>%
</pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">
<p><img src="2023-06-11-I-dont-like-collars_files/figure-html/cell-63-output-1.png" class="img-fluid"></p>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>